<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChain åŒºå—é“¾æµè§ˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .stat-box h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-box p {
            font-size: 2em;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .block-list, .tx-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .block-item, .tx-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .block-item h4, .tx-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .block-item p, .tx-item p {
            color: #666;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .address {
            font-family: monospace;
            background: #e8eaf6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
            font-size: 1.1em;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #2e7d32;
        }

        .result {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— MyChain åŒºå—é“¾æµè§ˆå™¨</h1>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-box">
                <h3>å½“å‰åŒºå—é«˜åº¦</h3>
                <p id="blockHeight">åŠ è½½ä¸­...</p>
            </div>
            <div class="stat-box">
                <h3>èŠ‚ç‚¹çŠ¶æ€</h3>
                <p id="nodeStatus">æ£€æŸ¥ä¸­...</p>
            </div>
            <div class="stat-box">
                <h3>é“¾ ID</h3>
                <p id="chainId">-</p>
            </div>
        </div>

        <!-- ç”¨æˆ·æ“ä½œ -->
        <div class="card">
            <h2>ğŸ‘¤ ç”¨æˆ·æ“ä½œ</h2>
            <div id="userMessage"></div>
            
            <div class="input-group">
                <label>ç”Ÿæˆæ–°è´¦æˆ·</label>
                <button onclick="createAccount()">åˆ›å»ºè´¦æˆ·</button>
            </div>

            <div class="input-group">
                <label>æŸ¥è¯¢ä½™é¢</label>
                <input type="text" id="balanceAddress" placeholder="è¾“å…¥åœ°å€æŸ¥è¯¢ä½™é¢">
                <button onclick="checkBalance()">æŸ¥è¯¢</button>
            </div>
            <div id="balanceResult"></div>
        </div>

        <!-- ä»£å¸æ“ä½œ -->
        <div class="card">
            <h2>ğŸ’° ä»£å¸æ“ä½œ</h2>
            <div id="tokenMessage"></div>

            <div class="input-group">
                <label>é“¸é€ ä»£å¸ï¼ˆéœ€è¦æœ‰æƒé™ï¼‰</label>
                <input type="text" id="mintRecipient" placeholder="æ¥æ”¶åœ°å€">
                <input type="text" id="mintAmount" placeholder="æ•°é‡ï¼ˆä¾‹å¦‚ï¼š1000tokenï¼‰">
                <button onclick="mintTokens()">é“¸é€ </button>
            </div>

            <div class="input-group">
                <label>è½¬è´¦ä»£å¸</label>
                <input type="text" id="transferFrom" placeholder="å‘é€æ–¹åœ°å€ï¼ˆéœ€è¦åœ¨æœ¬åœ°æœ‰å¯†é’¥ï¼‰">
                <input type="text" id="transferTo" placeholder="æ¥æ”¶æ–¹åœ°å€">
                <input type="text" id="transferAmount" placeholder="æ•°é‡ï¼ˆä¾‹å¦‚ï¼š100tokenï¼‰">
                <button onclick="transferTokens()">è½¬è´¦</button>
            </div>

            <div class="input-group">
                <label>å¥–åŠ±çŸ¿å·¥</label>
                <input type="text" id="minerAddress" placeholder="çŸ¿å·¥åœ°å€">
                <button onclick="rewardMiner()">å‘æ”¾å¥–åŠ±</button>
            </div>
        </div>

        <!-- äº¤æ˜“å†å² -->
        <div class="card">
            <h2>ğŸ“œ äº¤æ˜“å†å²</h2>
            <div class="input-group">
                <label>æŸ¥è¯¢åœ°å€çš„äº¤æ˜“å†å²</label>
                <input type="text" id="txHistoryAddress" placeholder="è¾“å…¥åœ°å€æŸ¥è¯¢äº¤æ˜“å†å²">
                <button onclick="queryTransactionHistory()">æŸ¥è¯¢äº¤æ˜“</button>
            </div>
            <div id="transactions" class="tx-list">
                <div class="loading">è¯·è¾“å…¥åœ°å€æŸ¥è¯¢äº¤æ˜“å†å²</div>
            </div>
        </div>

        <!-- æœ€æ–°åŒºå— -->
        <div class="card">
            <h2>ğŸ“¦ æœ€æ–°åŒºå—</h2>
            <button onclick="refreshBlocks()">åˆ·æ–°</button>
            <div id="blocks" class="block-list">
                <div class="loading">åŠ è½½åŒºå—ä¿¡æ¯...</div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <ol style="padding-left: 20px; line-height: 1.8;">
                <li>é¦–å…ˆç¡®ä¿åŒºå—é“¾èŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼ˆåœ¨ç»ˆç«¯æ‰§è¡Œ <code>ignite chain serve</code>ï¼‰</li>
                <li>åˆ›å»ºæ–°è´¦æˆ·ä¼šç”Ÿæˆåœ°å€å’ŒåŠ©è®°è¯ï¼Œè¯·ä¿å­˜å¥½åŠ©è®°è¯</li>
                <li>ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·å¯¼å…¥è´¦æˆ·ï¼š<code>mychaind keys add [è´¦æˆ·å] --recover</code></li>
                <li>é“¸é€ å’Œè½¬è´¦éœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼Œç¤ºä¾‹ï¼š
                    <ul style="margin-top: 10px;">
                        <li><code>mychaind tx token mint-tokens [æ•°é‡] [åœ°å€] --from [è´¦æˆ·å] --chain-id mychain</code></li>
                        <li><code>mychaind tx token transfer-tokens [æ¥æ”¶åœ°å€] [æ•°é‡] --from [è´¦æˆ·å] --chain-id mychain</code></li>
                    </ul>
                </li>
                <li>æŸ¥è¯¢ä½™é¢å’ŒåŒºå—ä¿¡æ¯å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨</li>
            </ol>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:1317';
        const RPC_URL = 'http://localhost:26657';

        // è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                // è·å–æœ€æ–°åŒºå—é«˜åº¦
                const response = await fetch(`${RPC_URL}/status`);
                const data = await response.json();
                
                if (data.result) {
                    const height = data.result.sync_info.latest_block_height;
                    document.getElementById('blockHeight').textContent = height;
                    document.getElementById('nodeStatus').textContent = 'âœ… åœ¨çº¿';
                    document.getElementById('chainId').textContent = data.result.node_info.network;
                }
            } catch (error) {
                document.getElementById('blockHeight').textContent = 'é”™è¯¯';
                document.getElementById('nodeStatus').textContent = 'âŒ ç¦»çº¿';
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºæ–°è´¦æˆ·
        function createAccount() {
            const mnemonic = generateMnemonic();
            showMessage('userMessage', `
                <div class="success">
                    <strong>æ–°è´¦æˆ·å·²ç”Ÿæˆï¼</strong><br><br>
                    <strong>åŠ©è®°è¯ï¼ˆè¯·å®‰å…¨ä¿å­˜ï¼‰ï¼š</strong><br>
                    <div class="result">${mnemonic}</div>
                    <br>
                    <strong>å¯¼å…¥è´¦æˆ·å‘½ä»¤ï¼š</strong><br>
                    <code>mychaind keys add myaccount --recover</code><br>
                    ç„¶åç²˜è´´ä¸Šé¢çš„åŠ©è®°è¯
                </div>
            `);
        }

        // ç”ŸæˆåŠ©è®°è¯ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”ä½¿ç”¨BIP39ï¼‰
        function generateMnemonic() {
            const words = ['abandon', 'ability', 'able', 'about', 'above', 'absent', 'absorb', 'abstract', 'absurd', 'abuse', 
                          'access', 'accident', 'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire', 'across', 'act',
                          'action', 'actor', 'actress', 'actual', 'adapt', 'add', 'addict', 'address', 'adjust', 'admit'];
            const mnemonic = [];
            for (let i = 0; i < 24; i++) {
                mnemonic.push(words[Math.floor(Math.random() * words.length)]);
            }
            return mnemonic.join(' ');
        }

        // æŸ¥è¯¢ä½™é¢
        async function checkBalance() {
            const address = document.getElementById('balanceAddress').value;
            if (!address) {
                showMessage('userMessage', '<div class="error">è¯·è¾“å…¥åœ°å€</div>');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cosmos/bank/v1beta1/balances/${address}`);
                const data = await response.json();
                
                if (data.balances && data.balances.length > 0) {
                    let balanceHtml = '<div class="success"><strong>è´¦æˆ·ä½™é¢ï¼š</strong><br>';
                    data.balances.forEach(balance => {
                        const amount = (parseInt(balance.amount) / 1000000).toFixed(6);
                        balanceHtml += `${amount} ${balance.denom}<br>`;
                    });
                    balanceHtml += '</div>';
                    document.getElementById('balanceResult').innerHTML = balanceHtml;
                } else {
                    document.getElementById('balanceResult').innerHTML = '<div class="error">è´¦æˆ·ä½™é¢ä¸º 0 æˆ–åœ°å€ä¸å­˜åœ¨</div>';
                }
            } catch (error) {
                document.getElementById('balanceResult').innerHTML = '<div class="error">æŸ¥è¯¢å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // é“¸é€ ä»£å¸æç¤º
        function mintTokens() {
            const recipient = document.getElementById('mintRecipient').value;
            const amount = document.getElementById('mintAmount').value;
            
            if (!recipient || !amount) {
                showMessage('tokenMessage', '<div class="error">è¯·å¡«å†™æ‰€æœ‰å­—æ®µ</div>');
                return;
            }

            showMessage('tokenMessage', `
                <div class="success">
                    <strong>è¯·åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</strong><br><br>
                    <div class="result">mychaind tx token mint-tokens ${amount} ${recipient} --from [ä½ çš„è´¦æˆ·å] --chain-id mychain --yes</div>
                </div>
            `);
        }

        // è½¬è´¦æç¤º
        function transferTokens() {
            const to = document.getElementById('transferTo').value;
            const amount = document.getElementById('transferAmount').value;
            
            if (!to || !amount) {
                showMessage('tokenMessage', '<div class="error">è¯·å¡«å†™æ‰€æœ‰å­—æ®µ</div>');
                return;
            }

            showMessage('tokenMessage', `
                <div class="success">
                    <strong>è¯·åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</strong><br><br>
                    <div class="result">mychaind tx token transfer-tokens ${to} ${amount} --from [ä½ çš„è´¦æˆ·å] --chain-id mychain --yes</div>
                </div>
            `);
        }

        // å¥–åŠ±çŸ¿å·¥
        function rewardMiner() {
            const miner = document.getElementById('minerAddress').value;
            
            if (!miner) {
                showMessage('tokenMessage', '<div class="error">è¯·è¾“å…¥çŸ¿å·¥åœ°å€</div>');
                return;
            }

            showMessage('tokenMessage', `
                <div class="success">
                    <strong>è¯·åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</strong><br><br>
                    <div class="result">mychaind tx token reward-miner ${miner} --from [ä½ çš„è´¦æˆ·å] --chain-id mychain --yes</div>
                    <br>
                    çŸ¿å·¥å°†è·å¾— 10 token ä½œä¸ºåŒºå—å¥–åŠ±
                </div>
            `);
        }

        // åˆ·æ–°åŒºå—ä¿¡æ¯
        async function refreshBlocks() {
            const blocksDiv = document.getElementById('blocks');
            blocksDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const statusResponse = await fetch(`${RPC_URL}/status`);
                const statusData = await statusResponse.json();
                const latestHeight = parseInt(statusData.result.sync_info.latest_block_height);

                let blocksHtml = '';
                const startHeight = Math.max(1, latestHeight - 9);

                for (let height = latestHeight; height >= startHeight; height--) {
                    try {
                        const blockResponse = await fetch(`${RPC_URL}/block?height=${height}`);
                        const blockData = await blockResponse.json();
                        const block = blockData.result.block;

                        blocksHtml += `
                            <div class="block-item">
                                <h4>åŒºå— #${height}</h4>
                                <p><strong>åŒºå—å“ˆå¸Œ:</strong> <span class="address">${blockData.result.block_id.hash}</span></p>
                                <p><strong>æ—¶é—´:</strong> ${new Date(block.header.time).toLocaleString('zh-CN')}</p>
                                <p><strong>æè®®è€…:</strong> <span class="address">${block.header.proposer_address}</span></p>
                                <p><strong>äº¤æ˜“æ•°é‡:</strong> ${block.data.txs ? block.data.txs.length : 0}</p>
                            </div>
                        `;
                    } catch (error) {
                        console.error(`è·å–åŒºå— ${height} å¤±è´¥:`, error);
                    }
                }

                blocksDiv.innerHTML = blocksHtml || '<div class="loading">æš‚æ— åŒºå—æ•°æ®</div>';
            } catch (error) {
                blocksDiv.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æŸ¥è¯¢äº¤æ˜“å†å²
        async function queryTransactionHistory() {
            const address = document.getElementById('txHistoryAddress').value;
            if (!address) {
                document.getElementById('transactions').innerHTML = '<div class="error">è¯·è¾“å…¥åœ°å€</div>';
                return;
            }

            const txDiv = document.getElementById('transactions');
            txDiv.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢äº¤æ˜“å†å²...</div>';

            try {
                // æ–¹æ³•1: æŸ¥è¯¢ä½œä¸ºå‘é€æ–¹çš„äº¤æ˜“
                const senderQuery = `message.sender='${address}'`;
                const senderUrl = `${RPC_URL}/tx_search?query="${encodeURIComponent(senderQuery)}"&per_page=20&order_by="desc"`;
                
                const response = await fetch(senderUrl);
                const data = await response.json();

                if (data.result && data.result.txs && data.result.txs.length > 0) {
                    let txHtml = '<h3>äº¤æ˜“è®°å½•ï¼ˆæœ€è¿‘20æ¡ï¼‰</h3>';
                    
                    data.result.txs.forEach((tx, index) => {
                        const txHash = tx.hash;
                        const height = tx.height;
                        const time = new Date(tx.tx_result.log).toLocaleString('zh-CN') || 'æœªçŸ¥æ—¶é—´';
                        const success = tx.tx_result.code === 0;
                        
                        // è§£æäº¤æ˜“ç±»å‹
                        let txType = 'æœªçŸ¥äº¤æ˜“';
                        let txDetails = '';
                        
                        try {
                            if (tx.tx_result.log) {
                                const logData = JSON.parse(tx.tx_result.log);
                                if (logData[0] && logData[0].events) {
                                    logData[0].events.forEach(event => {
                                        if (event.type === 'message') {
                                            event.attributes.forEach(attr => {
                                                if (attr.key === 'action') {
                                                    if (attr.value.includes('MsgTransferTokens')) {
                                                        txType = 'ğŸ’¸ ä»£å¸è½¬è´¦';
                                                    } else if (attr.value.includes('MsgMintTokens')) {
                                                        txType = 'ğŸª™ é“¸é€ ä»£å¸';
                                                    } else if (attr.value.includes('MsgRewardMiner')) {
                                                        txType = 'â›ï¸ çŸ¿å·¥å¥–åŠ±';
                                                    } else if (attr.value.includes('MsgSend')) {
                                                        txType = 'ğŸ’° è½¬è´¦';
                                                    }
                                                }
                                            });
                                        }
                                        if (event.type === 'transfer') {
                                            event.attributes.forEach(attr => {
                                                if (attr.key === 'amount') {
                                                    txDetails += `é‡‘é¢: ${attr.value}<br>`;
                                                }
                                                if (attr.key === 'recipient') {
                                                    txDetails += `æ¥æ”¶æ–¹: <span class="address">${attr.value}</span><br>`;
                                                }
                                            });
                                        }
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('è§£æäº¤æ˜“æ—¥å¿—å¤±è´¥:', e);
                        }

                        const statusClass = success ? 'success' : 'error';
                        const statusText = success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                        
                        txHtml += `
                            <div class="tx-item">
                                <h4>${txType} - åŒºå— #${height}</h4>
                                <p><strong>äº¤æ˜“å“ˆå¸Œ:</strong> <span class="address">${txHash}</span></p>
                                <p><strong>çŠ¶æ€:</strong> <span class="${statusClass}">${statusText}</span></p>
                                <p><strong>å‘é€æ–¹:</strong> <span class="address">${address}</span></p>
                                ${txDetails}
                                <p style="color: #888; font-size: 0.9em;">æ—¶é—´: ${time}</p>
                            </div>
                        `;
                    });
                    
                    txDiv.innerHTML = txHtml;
                } else {
                    txDiv.innerHTML = '<div class="loading">è¯¥åœ°å€æš‚æ— äº¤æ˜“è®°å½•</div>';
                }
            } catch (error) {
                txDiv.innerHTML = '<div class="error">æŸ¥è¯¢å¤±è´¥: ' + error.message + '</div>';
                console.error('æŸ¥è¯¢äº¤æ˜“å†å²å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, html) {
            document.getElementById(elementId).innerHTML = html;
            setTimeout(() => {
                document.getElementById(elementId).innerHTML = '';
            }, 10000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateStats();
            refreshBlocks();
            // æ¯5ç§’åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
            setInterval(updateStats, 5000);
            // æ¯10ç§’åˆ·æ–°åŒºå—ä¿¡æ¯
            setInterval(refreshBlocks, 10000);
        };
    </script>
</body>
</html>
